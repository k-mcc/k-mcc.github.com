<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Air Pollution Injustice in Houston</title>

  <meta name="viewport" content="width=device-width"> <!--, initial-scale=1-->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
 integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
 crossorigin=""/>
 <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
crossorigin=""></script>
<!-- bivariate choropleths -->
<!-- font -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
<!-- easy button -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
<script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
<!-- search Bar -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<!-- L.Control.Button -->
<script src="https://raw.githubusercontent.com/jerroydmoore/leaflet-button/b568e84f4e46167c4a8a8f640e2b192afdc34930/L.Control.Button.js"></script>
<!-- data files -->
<script src="HoustonData/houNo2SEPT.js"></script> <!-- Houston data -->
<script src="https://k-mcc.github.io/no2WithDemIndex.js"></script> <!-- D.C. data -->
<!-- pie chart -->
<script src="https://cdn.anychart.com/releases/8.0.1/js/anychart-core.min.js"></script>
<script src="https://cdn.anychart.com/releases/8.0.1/js/anychart-pie.min.js"></script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<script src="https://k-mcc.github.io/geoJSON/houNHPoints.js"></script>
<script src="geoJSON/dcNHPoints.js"></script>
<script src="geoJSON/houSources.js"></script>
<link rel="stylesheet" href="css/no2EqualityMapsNav.css">
  <style>

  </style>
</head>
<body>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>

  <nav class="navbar navbar-expand-md" style="z-index:1001;">
    <a class="navbar-brand" href="houston-in-dev.html">Air Pollution Injustice</a>
    <button class="navbar-toggler navbar-dark" type="button" data-toggle="collapse" data-target="#main-navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="main-navigation">
      <ul class="navbar-nav">
        <li class="nav-item">
          <a class="nav-link active" href="houston-in-dev.html">Map</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="about-the-data.html">Data</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="story-map.html">Story</a>
        </li>
      </ul>
    </div>
  </nav>

  <div class="container-fluid">

  <nav id="bar" class="navbar fixed-bottom navbar-light bg-light navbar-expand-lg" style="z-index:1001; justify-content:left;">

    <div class="collapse navbar-collapse" id="toolbar" style="justify-content:left;">

    <ul class="navbar-nav">
    <li class="nav-item">
    <!-- Maps -->
    <div class="btn-group dropup" style="float:left;">
      <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Maps
      </button>
      <div class="dropdown-menu">
        <!-- Dropdown menu links -->
        <div class='chorOption' id='returnBtn' onclick = "returnToBivariate()">NO<sub>2</sub> Equality Index (Default)</div>
        <div class='chorOption' id='popAsianBtn' onclick = "showUniChoropleth('popAsian',2)">Asian</div>
        <div class='chorOption' id='popBlackOrAfrAmerBtn' onclick = "showUniChoropleth('popBlackOrAfrAmer',3)">Black or African American</div>
        <div class='chorOption' id='popHispanicBtn' onclick = "showUniChoropleth('popHispanic',4)">Hispanic or Latino</div>
        <div class='chorOption' id='popWhiteBtn' onclick = "showUniChoropleth('popWhite',5)">White (Non-Hispanic)</div>
      </div>
    </div>
    </li>

    <li class="nav-item">
    <!-- View Options -->
    <div class="btn-group dropup">
      <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        View Options
      </button>
      <div class="dropdown-menu">
        <!-- Dropdown menu links -->
        <div class='chorOption' id='fillBtn' onclick = "toggleOpacity('fill')">Fill</div>
        <div class='chorOption' id='outlineBtn' onclick = "toggleOpacity('outline')">Outline</div>
      </div>
    </div>
    </li>

    <li class="nav-item" id="paletteSelector">
    <!-- View Options -->
    <div class="btn-group dropup">
      <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        Colors
      </button>
      <div class="dropdown-menu">
        <!-- Dropdown menu links -->
        <div class='chorOption selected' id='button1' onclick = "setPalette(1)">&nbsp; 1<i id="a0"></i><i id="a1"></i><i id="a2"></i><i id="a3"></i></div>
        <div class='chorOption' id='button2' onclick = "setPalette(2)">&nbsp; 2<i id="b0"></i><i id="b1"></i><i id="b2"></i><i id="b3"></i></div>
      </div>
    </div>
    </li>

    <li class="nav-item">
    <div class="toggleBtnHolder">
      <button id="sources" type="button" class="btn" onclick="toggleLayer('sources')">
        NO<sub>X</sub> Sources
      </button>
    </div>
    </li>

    <li class="nav-item">
    <div class="toggleBtnHolder">
      <a class="btn" href="https://forms.gle/pdiqNVtPRMa8fYNp9" target="_blank" rel="noopener noreferrer">
        Give Feedback
      </a>
    </div>
    </li>

    </ul>

    </div>

    <button class="navbar-toggler navbar-light" type="button" data-toggle="collapse" data-target="#toolbar" onclick="changePos('bar')">
      <span class="navbar-toggler-icon"></span>
    </button>

  </nav>

</div>

  <body onload="load()">
  <div class='showLegendButton' id='gridContainerButton' ><h2>Legend</h2></div>


  <div id="map"></div>
  <div id="myModal" class="modal">

    <!-- Modal content -->
    <div id="modalContent" class="modal-content">
      <span class="close" onclick="closeModal()">&times;</span>
      <h3>Houston's NO<sub>2</sub> Equality Map</h3>
      <p>Where we live, work, and spend our time affects how much nitrogen dioxide (NO<sub>2</sub>) and other air pollutants we breathe. Many primary pollutants, including NO<sub>2</sub>, vary between neighborhoods in the same city. On average, Houstonâ€™s low-income residents and residents of color experience 30% higher burdens of NO<sub>2</sub>.</br></br>The NO<sub>2</sub> Equality Map aims to draw attention to this injustice as it compares NO<sub>2</sub> column densities and socio-demographic vulnerability. The NO<sub>2</sub> Equality Map currently displays data measured from space by <a href="http://www.tropomi.eu/" target="_blank" rel="noopener noreferrer">TROPOMI</a> on weekdays (September 2018 and 2019) at the census tract level. In the future, the NO<sub>2</sub> Equality Map will update in real time.</p>
      <img src="images/IntroSlide4.png" alt="Introduction" style="width:100%;height:100%;"> <!--2150px x 1350px-->
      <div id="exploreBtnContainer" class='exploreBtnContainer' onclick="closeModal()"><div class='exploreBtn' id='exploreBtn' onclick="closeModal()">Enter</div></div>
    </div>

  </div>
<script>

  function adaptToScreen() {

    var width = (window.innerWidth > 0) ? window.innerWidth : screen.width;

    if (width <= 768) {
      info.setPosition('bottomright');
    } else info.setPosition('topright');

    // INFO BOX
    var infoBox = document.getElementById('info');
    if (infoBox != null) {
      infoBox.style.setProperty('--info-height', getElementSize(width, infoHeight) + 'px');
      infoBox.style.setProperty('--info-width', getElementSize(width, infoWidth));

      var elem = L.DomUtil.get('info');
      L.DomEvent.on(elem, 'mousewheel', L.DomEvent.stopPropagation);

    }

    var gc = document.getElementById('gridContainer');
    if (gc != null) {
      gc.style.setProperty('--grid-container-bottom', getElementProperty(width, 768, 300 + 'px', 10 + 'vh'));
      gc.style.setProperty('--grid-container-font-size', getElementProperty(width, 768, 10 + 'px', 1.2 + 'vw'));
    }

    var showLegendButton = document.getElementById('gridContainerButton');
    if (showLegendButton != null) {
      showLegendButton.style.setProperty('--show-legend-button-bottom', getElementProperty(width, 768, 300 + 'px', 60 + 'px'));
    }

    var eles = document.getElementsByClassName('grid-item');
    if (eles.length > 0) {
      for (var i = 0; i < eles.length; i++) {
        eles[i].style.setProperty('--grid-item-padding', getElementProperty(width, 768, 23 + 'px', 2.8 + 'vw'));
      }
    }

    var ebc = document.getElementById('exploreBtnContainer');
    if (ebc != null) {
      ebc.style.setProperty('--explore-btn-c-h', getElementProperty(width, 768, 30 + 'px', 60 + 'px'));
      ebc.style.setProperty('--explore-btn-c-w', getElementProperty(width, 768, 150 + 'px', 300 + 'px'));
      ebc.style.setProperty('--explore-btn-c-p', getElementProperty(width, 768, 0.5 + '%', 1 + '%'));
      ebc.style.setProperty('--explore-btn-c-m', getElementProperty(width, 768, 1 + '%', 2 + '%'));
    }

    var eb = document.getElementById('exploreBtn');
    if (eb != null) {
      eb.style.setProperty('--explore-btn-font-size', getElementProperty(width, 768, 30 + 'px', 50 + 'px'));
    }

    var mc = document.getElementById('modalContent');
    if (mc != null) {
      mc.style.setProperty('--modal-content-p-size', getElementProperty(width, 768, 16 + 'px', 24 + 'px'));
      mc.style.setProperty('--modal-content-h3-size', getElementSize(width, mcH3Size) + 'px');
    }


  }

  var infoHeight = [600,550,500,200,200];
  var infoWidth = [450 + 'px',400 + 'px',350 + 'px', 97 + '%', 97 + '%'];
  var mcH3Size = [50, 45, 40, 35, 30];

  function getElementSize(x, arr) { //x = screenWidth, arr = array of element sizes at breakpoints
    return x > 1200  ? arr[0] :
           x > 992  ? arr[1] :
           x > 768  ? arr[2] :
           x > 600  ? arr[3] :
                      arr[4];
  }

  function getElementProperty(x, breakPt, valSm, valLg) {
    if (x > breakPt) return valLg;
    else return valSm;
  }

  var setDocumentVariable = function(propertyName, value) {
    document.documentElement.style.setProperty(propertyName, value);
  };

  function changePos(eleId) {
    document.getElementById(eleId).classList.toggle("popDown");
  }

  var mapboxAccessToken = 'pk.eyJ1Ijoia2F0ZW1hcCIsImEiOiJja3A0NWV0ZTkwNjBtMm5vdWxzcXR6dWxjIn0.7rYO_pPmtvwuWUb0cG3QXQ';
  var map = L.map('map').setView([29.7604, -95.3698], 12);
  var nhLayerIsOn;

  map.doubleClickZoom.disable();

  function load() {
    addChoropleth("Houston");
    currentOpacity = "";


    adaptToScreen();

    document.getElementById("myModal").style.display = "block";

    var elem = L.DomUtil.get('info');
    L.DomEvent.on(elem, 'mousewheel', L.DomEvent.stopPropagation);


    toggleOpacity("outline"); //"fill"
    //adaptToScreen();
  }

  var firstZoom = true;
  map.on('zoom', function () {

      var opacity;

      var arr = document.getElementsByClassName("neighborhoodLabel");

      var display = "";
      var className = "neighborhoodLabel";
      if (map.getZoom() < 14 && !firstZoom) {
        className = 'neighborhoodLabel fade-out-text';
        //opacity = 0;
      }
      else if (map.getZoom() >= 14) {
        className = 'neighborhoodLabel fade-in-text';
        display = "inline-block";
        firstZoom = false;
      }

      arr = document.getElementsByClassName("neighborhoodLabel");

      for (var i = 0; i < arr.length; i++) {
        arr[i].className = className;
        if (display != "")  arr[i].style.display = display;
      }
      var size = getFontSizeTop10(map.getZoom());

      var className = "top10";
      if (map.getZoom() < 12) className = 'top10 fade-out-text-top10';
      else if (map.getZoom() >= 12) {
        className = 'top10 fade-in-text-top10';
        if (!nhLayerIsOn) {
          nhLayer = L.geoJson(houNHs, {
            pointToLayer: paint
          }); //{layout: layout}
          nhLayer.addTo(map);
          nhLayerIsOn = true;
        }
      }

      arr = document.getElementsByClassName("top10");

      for (var i = 0; i < arr.length; i++) {
        arr[i].className = className;
        arr[i].style.fontSize = size;
      }
  });

  function getFontSize(z) { // z = zoom level
    return z >= 16  ? 18 :
           z >= 15  ? 16 :
           z >= 14  ? 14 :
           z >= 13  ? 0 :
           z >= 12  ? 0 :
           z >= 11  ? 0 :
                    0;
  }

  function getTextOpacity(z) { // z = zoom level
    return z >= 16  ? 1 :
           z >= 15  ? 0.9 :
           z >= 14  ? 0.6 :
           z >= 13  ? 0.3 :
           z >= 12  ? 0 :
           z >= 11  ? 0 :
                    0;
  }

  function getFontSizeTop10(z) { // z = zoom level
    return z >= 16  ? 26 :
           z >= 15  ? 24 :
           z >= 14  ? 22 :
           z >= 13  ? 20 :
           z >= 12  ? 18 :
           z >= 11  ? 12 :
                    10;
  }
  function getOpacityTop10(z) { // z = zoom level
    return z >= 12  ? 1 :
           z >= 11.5  ? 0.7 :
           z >= 11  ? 0.4 :
           z >= 10.5  ? 0.1 :
                    0;
  }


//var settingName = [fillOpacity, outlineWeight, outlineColor]
  var opacityFills = [0.9, 0.5, "white"];
  var opacityOutlines = [0.1, 3, 0];
  var opacitySetting;
  var currentOpacity;
  function toggleOpacity(setting) {
    if (setting == "outline") {
      if (currentOpacity == "outline") return "";
      opacitySetting = opacityOutlines;
      currentOpacity = "outline";
      changeButtonSelection("outlineBtn", "fillBtn");
    }
    else  if (setting == "fill") {
      if (currentOpacity == "fill") return "";
      opacitySetting = opacityFills;
      currentOpacity = "fill";
      changeButtonSelection("fillBtn", "outlineBtn");
    }

    numVars = 2;

    fillOpacityVal = opacitySetting[0];
    weightVal = opacitySetting[1];
    colorVal = opacitySetting[2];

    var sourcesWasOn = false;
    if (sourcesIsOn) {
      sourcesWasOn = true;
      toggleLayer(sources);
    }

      if (houstonIsOn) { // Repaint Houston layer
        if (singleLayerOn == "") {
          map.removeLayer(houston);

          geojson = L.geoJson(houLayer);

          houston = L.geoJson(houLayer, {
              style: style,
              onEachFeature: onEachFeature
          });

          var layer = houston.addTo(map);

          geojson = layer;
        }
        else {
          map.removeLayer(univariateChoropleth);

          addChoropleth(singleVariable);
        }
      }
      if (dcIsOn) { // Repaint DC layer
        map.removeLayer(dc);

        geojson = L.geoJson(dcLayer);

        dc = L.geoJson(dcLayer, {
            style: style,
            onEachFeature: onEachFeature
        });
        var layer = dc.addTo(map);

        geojson = layer;
      }

      if (sourcesWasOn) {
        toggleLayer(sources);
      }

      zoom = false;
      zoomToFeature(clickEvent);
      zoom = true;
  }

  //countCityClicks = 1;

  var tileL = L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=' + mapboxAccessToken, {
      id: 'mapbox/dark-v9', //light
      attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
      tileSize: 512,
      zoomOffset: -1
  }).addTo(map);

  // city markers
  var houName = "Houston";
  var wdcName = "Washington, D.C.";
  //var hou = addCityMarker(houName, 'pie'); //plots Houston's city marker
  //var wdc = addCityMarker(wdcName, 'pie'); //plots DC's city marker
  var currentCityMarkerType;
  var gridContainerID = "gridContainer";
  var explodedPieSect = 0;
  //var donutLegendID = "donutLegend";
  //var cities = L.layerGroup(hou, wdc);

  var dropdownIDs = ["myDropdown", "designDropdown"];
  var dropdownShowing = "";

  function toggleChorDropdown(id) {
    document.getElementById(id).classList.toggle("show");
    /*for (var i = 0; i < dropdownIDs.length; i++) {
      if (dropdownIDs[i] == id) {
        document.getElementById(id).classList.toggle("show");
      }
      /else if (dropdownIDs[i] == dropdownShowing) {
        document.getElementById(dropdownShowing).classList.toggle("show");
      }
    }
    dropdownShowing = id;*/
  }

  function returnToBivariate() {
    if (singleLayerOn != "") {
      explodedPieSect = 0;
      toggleUnivariateChoropleth(singleVariable);
      changeButtonSelection("returnBtn", singleVariable + "Btn");
      singleVariable = "";
    }
  }

  function showUniChoropleth(race, sectionNum) {
    explodedPieSect = sectionNum;
    toggleUnivariateChoropleth(race);
  }

  function numberWithCommas(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
  }

    // Get the modal
  var modal = document.getElementById("myModal");

  // Get the <span> element that closes the modal
  var xLightbox = document.getElementsByClassName("close")[0];

  // When the user clicks on <span> (x), close the modal
  function closeModal() {
    document.getElementById('myModal').style.display = "none";
  }

  function openModal() {
    document.getElementById('myModal').style.display = "block";
  }

  // When the user clicks anywhere outside of the modal, close it
  window.onclick = function(event) {
    if (event.target == modal) {
      modal.style.display = "none";
    }
  }

/*  function returnToBivariate(specialCase) {
    if (singleLayerOn != "") {
      map.removeLayer(univariateChoropleth);
      document.getElementById(propName + "Btn").style.background = "#FFFFFF";
      document.getElementById(propName + "Btn").style.color = "#000000";
      singleLayerOn = "";
    }
  }*/

  /*function load() {
    setTimeout(
    function() {
      addChoropleth(houName);
      map.options.minZoom = 10;
      map.options.maxZoom = 30;
      //map.setView([29.7604, -95.3698], 11);
      countCityClicks++;
      map.flyTo([29.7604, -95.3698], 11, {duration: 1, easeLinearity: 0.2});
    }, 2000);
  }*/
  //var popped = [];
  var popped = false;
  function popItUp(elementID) { // displays popup element
    var element = document.getElementById(elementID);
    if (element != null) {
      if (!popped) {
        pop(element);
        popped = true;
      }
      else {
        unpop(element);
        popped = false;
      }
      /*if (! (popped.includes(elementID)) ) {
        popped.push(elementID);
        popup.style.display = 'block';
      }
      else {
        var index = popped.indexOf(elementID);
        popped.splice(index, 1);
        popup.style.display = 'none';
      }*/
    }
    //if (popup != null) popup.style.display = "block";
  }

  function pop(ele){
    ele.style.display = 'block';
  }

  function unpop(ele){
    ele.style.display = 'none';
  }

  function xButton(elementID, defaultDisplay) { // sets element display to none
    var ele = document.getElementById(elementID);
    if (ele != null) {
      ele.style.display = "none";
      makeShowLegendButton(elementID, defaultDisplay);
    }
  }

  function showLegend(legendID, defaultDisplay) {
    var legend = document.getElementById(legendID);
    if (legend != null) legend.style.display = defaultDisplay;
    var button = document.getElementById(legendID + 'Button');
    button.style.display = "none";
    var index = hiddenLegends.indexOf(legendID);
    hiddenLegends.splice(index, 1);
  }

  function makeShowLegendButton(legendID, defaultDisplay) {
    var button = document.getElementById(legendID + "Button");
    button.onclick = function() {
      showLegend(legendID, defaultDisplay)
    };
    button.style.display = "block";
    hiddenLegends.push(legendID);
  }

  // bivariate choropleths

  var colors;
  var geojson;
  var clickedTract;
  var previousTarget;
  var clickEvent;
  var img = L.control({position: 'bottomleft'});
  var info = L.control();

  var searchBar = L.Control.geocoder({position: 'topleft'});
  searchBar.addTo(map);

  var numVars;
  var singleVariable;
  var univariateChoropleth;
  var singleLayerOn;
  /*var univariateButton = L.easyButton('<img src="images/countryView.png" alt="Zoom out to country" style="width:24px;height:20px;position:absolute;left: -1; right: -3px; top: 4px; bottom: 0px;">', function(btn, map){
      numVars = 1;
      addChoropleth("white");
  });*/
  var zoom = true;
  var houston; // Houston's choropleth layer
  var dc; // D.C.'s choropleth layer
  var houstonIsOn;
  var dcIsOn;
  var countCityClicks = 1;
  var firstTimeInCity = true;
  var hiddenLegends = [];
  var nhLayer;

  function addChoropleth(cityName) {

    var sourcesWasOn = false;
    if (sourcesIsOn) {
      sourcesWasOn = true;
      toggleLayer(sources);
    }

    if (firstTimeInCity) {
      clickedTract = "";
      previousTarget = "";
      clickEvent = "";
      zoom = true;

      if (countCityClicks == 1) {
        colors = paletteA;
        changeButtonSelection("button1","button2");
      }

      singleLayerOn = "";
      firstTimeInCity = false;
    }

    if (cityName == "Houston") { // Add Houston layer
      numVars = 2;
      houstonIsOn = true;
      if (singleLayerOn != "") {
        toggleUnivariateChoropleth(singleVariable);
      }
      singleLayerOn = "";

      geojson = L.geoJson(houLayer);

      houston = L.geoJson(houLayer, {
          style: style,
          onEachFeature: onEachFeature
      });

      var layer = houston.addTo(map);

      geojson = layer;
      if (map.getZoom >= 12) {
        nhLayer = L.geoJson(houNHs, {
          pointToLayer: paint
        }); //{layout: layout}
        nhLayer.addTo(map);
        nhLayerIsOn = true;
      } else {
        nhLayerIsOn = false;
      }
      map.removeControl(img);
      img.addTo(map);

      if (hiddenLegends.includes(gridContainerID)) {
        document.getElementById(gridContainerID).style.display = "none";
        document.getElementById(gridContainerID + "Button").style.display = "block";
      }
      info.addTo(map);
      adaptToScreen();

      changeButtonSelection("returnBtn","");
    }
    else if (cityName == "Washington, D.C.") {  // Add DC layer
      numVars = 2;
      dcIsOn = true;
      if (singleLayerOn != "") {
        toggleUnivariateChoropleth(singleVariable);
      }
      singleLayerOn = "";

      geojson = L.geoJson(dcLayer);

      dc = L.geoJson(dcLayer, {
          style: style,
          onEachFeature: onEachFeature
      });
      var layer = dc.addTo(map);

      geojson = layer;

      map.removeControl(img);
      img.addTo(map);

      if (hiddenLegends.includes(gridContainerID)) {
        document.getElementById(gridContainerID).style.display = "none";
        document.getElementById(gridContainerID + "Button").style.display = "block";
      }

      info.addTo(map);
      adaptToScreen();

      changeButtonSelection("returnBtn","");
    }
    else {
      numVars = 1;
      singleVariable = cityName;

      var buttonID = singleVariable + "Btn";
      changeButtonSelection(buttonID,"");

      if (houstonIsOn) { // Remove Houston layer
        map.removeLayer(houston);

        geojson = L.geoJson(houLayer);

        univariateChoropleth = L.geoJson(houLayer, {
            style: style,
            onEachFeature: onEachFeature
        });

        var layer = univariateChoropleth.addTo(map);

        geojson = layer;
      }

      if (hiddenLegends.includes(gridContainerID)) {
        document.getElementById(gridContainerID).style.display = "none";
        document.getElementById(gridContainerID + "Button").style.display = "block";
      }

      info.addTo(map);
      adaptToScreen();
    }

    if (sourcesWasOn) {
      toggleLayer(sources);
    }

  }

  function paint(feature, latlng) {

    var textLabel = feature.properties.SNBNAME

    var top10 = feature.properties.Top10;
    var addClass = "neighborhoodLabel ";

    if (top10 == "Y") addClass = " top10  fade-in-text-top10 "; //top10

    var nhTextIcon = L.divIcon({
      className: 'nhMarker',
      html: "<h4 class='" + addClass + "'>" + feature.properties.SNBNAME + "</h4>",
      iconSize: [200,10]
    });

    //var
    //element.style.setProperty("--nhFactor", feature.properties.ShapeSTArea);

    return L.marker(latlng, {
       icon: nhTextIcon,
       title: feature.properties.SNBNAME,
       interactive: false
    });
  }

  function toggleUnivariateChoropleth(propName) {

    firstTimeInCity = false;

    if (singleLayerOn == propName) {
      map.removeLayer(univariateChoropleth);
      changeButtonSelection("returnBtn", propName + "Btn");
      //remove uni legend, too
      singleLayerOn = "";
      addChoropleth(houName);
      addChoropleth(wdcName);
    }

    else if (singleLayerOn != "") {
      map.removeLayer(univariateChoropleth);
      changeButtonSelection("", singleVariable + "Btn");
      changeButtonSelection("", "returnBtn");

      map.removeLayer(univariateChoropleth);

      singleLayerOn = propName;
      addChoropleth(propName);


      uniLegend();
    }

    else {
      changeButtonSelection(propName + "Btn", "returnBtn");
      singleLayerOn = propName;
      addChoropleth(propName);
      uniLegend();
    }

  }

  function removeChoroplethControls() {

      document.getElementById(gridContainerID).style.display = "none";
      document.getElementById(gridContainerID + "Button").style.display = "none";
      var squares = document.getElementsByClassName("grid-item");
      for (i = 0; i < squares.length; i++) {
        squares[i].style.display = "none";
      }
      var axes = document.getElementsByClassName("axis");
      for (i = 0; i < axes.length; i++) {
        axes[i].style.display = "none";
      }
      var infoBoxDiv =document.getElementById("info");
      infoBoxDiv.style.display = "none";
      if (houstonIsOn) { // Remove Houston layer
        map.removeLayer(houston);
        houstonIsOn = false;
      }
      if (dcIsOn) { // Remove DC layer
        map.removeLayer(dc);
        dcIsOn = false;
      }

      document.getElementById("button1").style.display = "none";
      document.getElementById("button2").style.display = "none";

  }

  // Joshua Stevens
  //var paletteA = ['#E8E8E8', '#ACE4E4', '#5AC8C8', '#DFB0D6', '#A5ADD3', '#5698B9', '#BE64AC', '#8C62AA', '#3B4994'];     // sq1                                   sq2                                  sq3                                 top10
  var paletteA = ['#E8E8E8', '#ACE4E4', '#5AC8C8', '#DFB0D6', '#A5ADD3', '#5698B9', '#BE64AC', '#8C62AA', '#3B4994',       '#D79DCC', '#CF8AC1', '#C677B7',        '#9F9AC9', '#9988BF', '#9275B4',      '#4F84B0', '#4971A7', '#425D9D',      '#FFFF00'];
  /*
  '#BE64AC' '#8C62AA' '#3B4994'
  '#DFB0D6' '#A5ADD3' '#5698B9'
  '#E8E8E8' '#ACE4E4' '#5AC8C8' */
  for (var i = 0; i < 4; i++) {
    var corners = [0, 2, 6, 8];
    var idStr = "a" + i;
    document.getElementById(idStr).style.background = paletteA[corners[i]];
  }
  // gridA.png option 2 //                                                                                                      sq1                                   sq2                                       sq3                             top10
  var paletteB = ['#F3F3F3', '#B4D3E1', '#509DC2', '#F3E6B3', '#B3B3B3', '#376387', '#F3B300', '#B36600', '#000000',         '#F3D986', '#F3CD5A', '#F3C02D',        '#B3A086', '#B38D5A', '#B3792D',      '#294A65', '#1C3244', '#0E1922',      '#00CC00'];
  /*
  '#F3B300', '#B36600', '#000000'
  '#F3E6B3', '#B3B3B3', '#376387',
  '#F3F3F3', '#B4D3E1', '#509DC2',
  */

  for (var i = 0; i < 4; i++) {
    var corners = [0, 2, 6, 8];
    var idStr = "b" + i;
    document.getElementById(idStr).style.background = paletteB[corners[i]];
  }

  img.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'grid-container');
    div.id = gridContainerID;
    div.style.display = "inline-grid";
    div.style.zIndex = 200;
    var grades = [1, 40, 99];

    div.innerHTML += "<div class='xButton' onclick='xButton(\"gridContainer\", \"inline-grid\")' ><h2 style='top: -47px; left: -26px'>âœ•</h2></div><h3 class='axis'>Nitrogen Dioxide Percentile <span class='popup' id='Idiot'><span class='popupBtn' style='visibility: visible;'>ðŸ–²</span><p><strong>Combined Index Score: </strong></br>The average.</p></span></h3><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[0],"") + "\" id:\"a3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[1],"") + "\" id:\"b3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[2],"") + "\" id:\"c3\" ></div>";
    div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[0],"") + "\" id:\"a2\"></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[1],"") + "\" id:\"b2\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[2],"") + "\" id:\"c2\" ></div>";
    div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[0],"") + "\" id:\"a1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[1],"") + "\" id:\"b1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[2],"") + "\" id:\"c1\" ></div><h2 class='axis' >Socio-Demographic Index <span onclick=\"infoPop(demAxisPop)\">&#9432;</span></h2>";

    //div.innerHTML += "<div style='background: #000; color: " + colors[18] + ";'>&#9634;</div>";
    div.innerHTML += "<span class='outline-key'><span style='color: " + colors[18] + "; background-color: " + colors[18] + "; padding: 2px; border: 2px solid black;'>&#9634;</span> The 25 tracts with the highest combined scores are outlined in " + outlineColorName + ".</span>";

    var draggable = new L.Draggable(div);
    draggable.enable();

    return div;
  }

  info.onAdd = function (map) {
      this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
      this._div.id = "info";
      this._div.innerHTML = '<h2>NO<sub>2</sub> Equality Index</h2></br>Hover or click on a census tract to get started.';
      var draggable = new L.Draggable(this._div);
      draggable.enable();
      return this._div;
  };

  window.addEventListener('resize', adaptToScreen);

  info.update = function (props) {
    this._div.innerHTML = '<h2>NO<sub>2</sub> Equality Index</h2>' +  (props ?

        '<h4 style="text-align: center;">Tract #' + props.TRACT + '</h4>' +
        '</br><div style="display: inline-grid;grid-template-columns: auto auto; height:5vh;"><div class="col-xs-12" style="justify-content: center;"><h1 style="color:' + adjustColor(props.no2Perc, 0) + ';">' + props.no2Perc + '</br></h1><h4>NO<sub>2</sub> Percentile</h4></div><div class="col-xs-12" style="justify-content: center;"><h1 style="color:' + adjustColor(0, props.demographicIndex) + ';">' + props.demographicIndex + '</h1><h4>Socio-Demographic Percentile</h4></div></div>' +
        '' +
        '<div style="margin-top: 60px;display: inline-grid;grid-template-columns: auto auto; height:5vh;padding-right:0px;"><div class="col-xs-12" style="justify-content: center;"><h1>$' + numberWithCommas(props.medianHHIncome) + '</h1></br><h4>Tract\'s Median Household Income</h4></div>' +
        '<div class="col-xs-12" style="justify-content: center;"><h1>$52,338</h1></br><h4>Houston\'s Median Household Income</h4>' +
        '</br></br>'
        : 'Click on a census tract');

        this._div.innerHTML += '<div id="piechart" style="left:0px;margin-left: 0px; padding: 0px;margin-top:100px;height: 300px; width: 100%;"></div>';

      pieDataArr = [];
      pieDataArr.push((props ? props.popNativeAmer : 0));
      pieDataArr.push((props ? props.popAsian : 0));
      pieDataArr.push((props ? props.popBlackOrAfrAmer : 0));
      pieDataArr.push((props ? props.popHispanic : 0));
      pieDataArr.push((props ? props.popWhite : 0));

      var totalOnPie = 0;
      for (var i = 0; i < pieDataArr.length; i++) totalOnPie += pieDataArr[i];

      var numOther = (props ? props.popTotal : 0) - totalOnPie;

      pieDataArr.push(numOther);

      pieDataArr.push((props ? props.popTotal : 0));

      google.charts.load('current', {'packages':['corechart']});
      google.charts.setOnLoadCallback(drawChart);
  };

  function infoPopUp(elementID) { // displays popup element
    var popup = document.getElementById(elementID);
    if (popup != null) popup.classList.toggle("show");
  }

  var tracker = 0;
  var no2AxisPop = "Nitrogen Dioxide Percentile\n\nTROPOMI measures nitrogen dioxide in terms of vertical column density.\n\nWe take that information at the pixel level and average it to census tracts.\n\nFinally, we convert that value to a percentile relative to all other census tracts in a city. Houston's Air Pollution Injustice Map currently displays the average NO2 density in September 2018 and September 2019.";
  var demAxisPop = "Socio-Demographic Index\n\nThe Socio-Demographic Index is the average of %low-income residents and %non-white residents in a census tract.\n\nThis quantity is expressed as a percentile relative to all other tracts in the city.\n\nAll demographic data is from the U.S. Census Bureau."
  function infoPop(text) {
    if (tracker == 1) {
      alert(text);
      tracker = 0;
    }
    else {
      tracker++;
    }
  }

  function drawChart() {

    var data = google.visualization.arrayToDataTable([
      ['Race or Ethnicity', 'Population'],
      ['American Indian/Alaska Native',     pieDataArr[0]],
      ['Asian',      pieDataArr[1]],
      ['Black or African American',  pieDataArr[2]],
      ['Hispanic or Latino', pieDataArr[3]],
      ['White (Non-Hispanic)',    pieDataArr[4]],
      ['Other',    pieDataArr[5]]
    ]);

    var titleStr = '';
    if (pieDataArr[6] > 0) titleStr = numberWithCommas(pieDataArr[6]) + ' People Live Here';

     var width = (window.innerWidth > 0) ? window.innerWidth : screen.width;
     var legendPosition;
     var ignoreBounds;

     if (width <= 800) {
       legendPosition = 'labeled';
       ignoreBounds = true;
     } else {
       legendPosition = 'labeled';
       ignoreBounds = true;
     }

    var options = {
      title: titleStr,
      titleTextStyle: {color: 'black', fontSize: 20},
      colors:['#ffa600','#ff5e6d','#b656a9','#265ca3','#6ecbdc','#7fd930'],
      backgroundColor: "#FFF",
      fontName: "Poppins",
      fontSize: "16",
      sliceVisibilityThreshold: 0,
      chartArea:{width:'100%'},
      legend:{position: legendPosition, textStyle: {color: 'black', fontSize: 13}},
      //tooltip:{trigger:'selection'}
      tooltip:{ignoreBounds: ignoreBounds, textStyle: {fontSize: '12'}}
    };

    var chart = new google.visualization.PieChart(document.getElementById('piechart'));

    chart.draw(data, options);
  }

  function adjustColor(prop1, prop2) {
    var suggestedColor = getColor(prop1,prop2,"");
    if (suggestedColor == colors[0] || suggestedColor == colors[1] || suggestedColor == colors[3]) { // if too light for a white background, change to black text.
      return LightenDarkenColor(suggestedColor, -50);
    }
    else if (singleLayerOn != "") { // if univariate choropleth
      return "#000000";
    }
    else return suggestedColor;
  }

  function LightenDarkenColor(colorCode, amount) {
    var usePound = false;

    if (colorCode[0] == "#") {
        colorCode = colorCode.slice(1);
        usePound = true;
    }

    var num = parseInt(colorCode, 16);

    var r = (num >> 16) + amount;

    if (r > 255) {
        r = 255;
    } else if (r < 0) {
        r = 0;
    }

    var b = ((num >> 8) & 0x00FF) + amount;

    if (b > 255) {
        b = 255;
    } else if (b < 0) {
        b = 0;
    }

    var g = (num & 0x0000FF) + amount;

    if (g > 255) {
        g = 255;
    } else if (g < 0) {
        g = 0;
    }

    return (usePound ? "#" : "") + (g | (b << 8) | (r << 16)).toString(16);
}



  function expo(x, f) {
    return Number.parseFloat(x).toExponential(f);
  }


  /*
  [ a3 ]  [ b3 ]  [ c3 ]
  [ a2 ]  [ b2 ]  [ c2 ]
  [ a1 ]  [ b1 ]  [ c1 ]
  */

    function getColor(axisA, axisB, variableA) {
      var x = variableA;
      if (numVars == 1) {
        return x >= 90  ? '#4D004B' :
               x >= 80  ? '#810F7C' :
               x >= 70  ? '#88419D' :
               x >= 60  ? '#8C6BB1' :
               x >= 50  ? '#8C96C6' :
               x >= 40   ? '#9EBCDA' :
               x >= 30   ? '#BFD3E6' :
               x >= 20   ? '#E0ECF4' :
               x >= 10   ? '#F7FCFD' :
               x > 0   ? '#FFFFFF' :
                        '#FFFFFF';
      }
      else if (numVars == 2) {
        var a = getRange(axisA);
        var b = getRange(axisB);

        if (a == 1) { //low axisA value
          if (b == 1) return colors[0]; //low axisB value
          else if (b == 2) return colors[1]; //mid axisB value
          else return colors[2]; //high axisB value
        }

        else if (a == 2) { //mid axisA value
          if (b == 1) return colors[3]; //low axisB value
          else if (b == 2) return colors[4]; //mid axisB value
          else return colors[5]; //high axisB value
        }

        else if (a == 3) { //high axisA value
          if (b == 1) return colors[9]; //low axisB value
          else if (b == 2) return colors[12]; //mid axisB value
          else return colors[15]; //high axisB value
        }

        else if (a == 4) { //high axisA value
          if (b == 1) return colors[10]; //low axisB value
          else if (b == 2) return colors[13]; //mid axisB value
          else return colors[16]; //high axisB value
        }

        else if (a == 5) { //high axisA value
          if (b == 1) return colors[11]; //low axisB value
          else if (b == 2) return colors[14]; //mid axisB value
          else return colors[17]; //high axisB value
        }

        else if (a == 6) { //high axisA value
          if (b == 1) return colors[6]; //low axisB value
          else if (b == 2) return colors[7]; //mid axisB value
          else return colors[8]; //high axisB value
        }
      }
    }

    function getRange(x) {
      return x >= 90  ? 6 :
             x >= 80  ? 5 :
             x >= 70  ? 4 :
             x >= 66.66  ? 3 : //high
             x >= 33.33  ? 2 : //mid
                      1; //low
    }

    function getColorRanked(rank, suggestedColor) {
      if (!(rank == null)) {
        if (singleLayerOn != "") return suggestedColor;
        return rank <= 25  ? colors[18] :
                          suggestedColor;
      }
      else return suggestedColor;
    }

    function getOutlineColor(rank, suggestedColor) {
      if (!(rank == null)) {
        return rank <= 25  ? colors[18] :
                          suggestedColor;
      }
      else return suggestedColor;
    }
    function getOutlineWeight(rank, suggestedWeight) {
      if (!(rank == null)) {
        if (singleLayerOn != "") return suggestedWeight;
        return rank <= 25  ? suggestedWeight: //+3
                             suggestedWeight;
      }
      else return suggestedWeight;
    }

    function getOutlineOpacity(rank) {
      if (!(rank == null)) {
        return rank <= 25  ? 1 :
                          0.5;
      }
      else return 0.5;
    }

    var fillOpacityVal;
    var colorVal;
    var weightVal;

    function style(feature) {
      var setColor;
      if (colorVal == "") {
        setColor = getColor(feature.properties.no2Perc, feature.properties.demographicIndex, ((feature.properties[singleVariable] / feature.properties.popTotal)*100));
      }
      else setColor = colorVal;
      return {
          fillColor: getColor(feature.properties.no2Perc, feature.properties.demographicIndex, ((feature.properties[singleVariable] / feature.properties.popTotal)*100)),
          weight: getOutlineWeight(feature.properties.comboRank, weightVal),
          opacity: getOutlineOpacity(feature.properties.comboRank),
          color: getColorRanked(feature.properties.comboRank, setColor), // outline color
          dashArray: '0',
          smoothFactor: 1,
          fillOpacity: fillOpacityVal
      };
      /*if (feature.properties.comboRank <= 25) {
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }
      }
      else {
        if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToBack();
        }
      }*/
    }

    function highlightFeature(e) {
        var layer = e.target;

        if ((layer.feature.properties.GEOID) != (clickedTract)) { //if not a clicked tract

          layer.setStyle({
            weight: 5,
            color: getOutlineColor(layer.feature.properties.comboRank, getColor(layer.feature.properties.no2Perc, layer.feature.properties.demographicIndex, ((layer.feature.properties[singleVariable] / layer.feature.properties.popTotal)*100))),
            //fill: false
            //fillColor: '#FFFFFF'
            fillOpacity: 0.4
          });
          /*if (layer.feature.properties.comboRank <= 15) {
            if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
                layer.bringToFront();
            }
          }*/

        }
        adaptToScreen();
        info.update(layer.feature.properties);
    }

    function resetHighlight(e) {
      var layer = e.target;
      if ((layer.feature.properties.GEOID) != (clickedTract)) {
        geojson.resetStyle(e.target);
      }
      //info.update();
    }

    var zoomableFeature = "";
    var previousZoom = "";
    function zoomToFeature(e) {
        var layer = e.target;
        clickEvent = e;

        zoomableFeature = e.target;

        e.target.bindPopup("<a onclick='zoomIntoFeature()' style='text-decoration: underline; cursor: pointer; font: 14px/16px 'Poppins', Helvetica, sans-serif; color: #808080;'>See this area</a>");

        zoom = true;

        layer.setStyle({
          weight: 5,
          color: getColor(layer.feature.properties.no2Perc, layer.feature.properties.demographicIndex, ((layer.feature.properties[singleVariable] / layer.feature.properties.popTotal)*100)),
          //fill: false
          //fillColor: '#FFFFFF'
          fillOpacity: 0
        });

        /*if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
        }*/

        adaptToScreen();
        info.update(layer.feature.properties);

        clickedTract = layer.feature.properties.GEOID;

        if ((previousTarget != "") && (previousTarget != e)) resetHighlight(previousTarget);

        previousTarget = e;

    }

    function zoomIntoFeature() {
      if (previousZoom != "" && previousZoom != zoomableFeature) {
        previousZoom.unbindPopup();
      }

      if (zoomableFeature != "") {
        previousZoom = zoomableFeature;
        map.fitBounds(zoomableFeature.getBounds(), {padding: [100, 100]});
      }
    }

    function onEachFeature(feature, layer) {
        layer.on({
            mouseover: highlightFeature,
            mouseout: resetHighlight,
            click: zoomToFeature
        });
    }

    // method that we will use to update the control based on feature properties passed
    /*info.update = function (props) {
        this._div.innerHTML = '<h2>NO<sub>2</sub> Equality Index</h2>' +  (props ?
            '<h3>NO<sub>2</sub> Index: ' + props.no2Perc + '</h3><br /><h3>Demographic Index: ' + props.demographicIndex + '</h3><br /><h3>Tract #' + props.TRACT + '</h3><br />'
            : 'Click on a census tract');
    };*/

    function updateImg() {

      var div = L.DomUtil.create('div', 'grid-container');
      div.id = gridContainerID;
      var grades = [1, 40, 90];

      div.innerHTML += "<div class='xButton' onclick='xButton(\"gridContainer\", \"inline-grid\")' ><h2>âœ•</h2></div><h3 class='axis' >Nitrogen Dioxide Percentile <span onclick='popItUp(\"Idiot\")'><p>HI</p><div class='popupText' id='Idiot'><p><strong>Combined Index Score: </strong></br>The average.</p></div></span></h3><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[0],"") + "\" id:\"a3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[1],"") + "\" id:\"b3\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[2],grades[2],"") + "\" id:\"c3\" ></div>";
      div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[0],"") + "\" id:\"a2\"></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[1],"") + "\" id:\"b2\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[1],grades[2],"") + "\" id:\"c2\" ></div>";
      div.innerHTML += "<div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[0],"") + "\" id:\"a1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[1],"") + "\" id:\"b1\" ></div><div class=\"grid-item\" style=\"background:" + getColor(grades[0],grades[2],"") + "\" id:\"c1\" ></div><h2 class='axis' >Socio-Demographic Index <span onclick=\"infoPop(demAxisPop)\">&#9432;</span></h2>";

      div.innerHTML += "<div style='color: " + colors[18] + ";'>&#9634;</div>";

      div.style.display = "inline-grid";

      var draggable = new L.Draggable(div);
      draggable.enable();

      return div;
    }

    var outlineColorName = "yellow";

    function setPalette(num) {

      returnToBivariate();

      var sourcesWasOn = false;
      if (sourcesIsOn) {
        sourcesWasOn = true;
        toggleLayer(sources);
      }
      if (num == 1) {
        colors = paletteA;
        //select button1
        changeButtonSelection("button1", "button2");
        outlineColorName = "yellow";
      }
      if (num == 2) {
        colors = paletteB;
        //select button2
        changeButtonSelection("button2", "button1");
        outlineColorName = "green";
      }

      map.removeControl(img);
      updateImg();
      img.addTo(map);
      adaptToScreen();
      if (hiddenLegends.includes(gridContainerID)) {
        document.getElementById(gridContainerID + "Button").style.display = "none";
      }

      numVars = 2;

        if (houstonIsOn) { // Repaint Houston layer
          map.removeLayer(houston);

          geojson = L.geoJson(houLayer);

          houston = L.geoJson(houLayer, {
              style: style,
              onEachFeature: onEachFeature
          });

          var layer = houston.addTo(map);

          geojson = layer;
        }
        if (dcIsOn) { // Repaint DC layer
          map.removeLayer(dc);

          geojson = L.geoJson(dcLayer);

          dc = L.geoJson(dcLayer, {
              style: style,
              onEachFeature: onEachFeature
          });
          var layer = dc.addTo(map);

          geojson = layer;
        }

        if (sourcesWasOn) {
          toggleLayer(sources);
        }

        zoom = false;
        zoomToFeature(clickEvent);
        zoom = true;
  }

  /*
  idOn    id of button to select
  idOff   id of button to deselect
  */
  function changeButtonSelection(idOn, idOff) {

    if (idOn != "") {
      var eleOn = document.getElementById(idOn);

      //if eleOn does not have selected class, add it
      if (!(eleOn.classList.contains("selected"))) {
        eleOn.classList.add("selected");
      }
    }

    if (idOff != "") {
      var eleOff = document.getElementById(idOff);

      //if eleOff has selected class, remove it
      if (eleOff.classList.contains("selected")) {
        eleOff.classList.remove("selected");
      }
    }

    //return true
    return true;
  }

  // univariate choropleth legend
  function uniLegend() {

    var div = document.getElementById(gridContainerID);
    var grades = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90];
    //<div class='popup' onclick='popItUp(\"no2AxisPopup\")' style='bottom:5px; left:5px;' ><img src='images/info.png' style='width:30px;height:30px;'></img><span class='popuptext' id='no2AxisPopup'><p><strong>Title: </strong></br>Description</p></span></div>
    //div.innerHTML += '<img src="images/no2dLegend.png" alt="Legend" style="width:300px;height:300px;">';

    div.innerHTML = '<img src="images/uniLegend.png" alt="Legend"class="uniLegend"></img>';
    //<div class="xButton" onclick="xButton(\"gridContainer\", \"inline-grid\")" style="right:35px;top:-43px;"><h2>âœ•</h2></div>
    /*for (var i = grades.length-1; i > 0; i--) {
        div.innerHTML +=
            '<h4>' + grades[i] + '<i style="background:' + getColor(0,0,grades[i] + 1) + '"></i></h4>' +
            '</br>';
    }*/

    div.style.display = "inline-block";
    //div.style.lineHeight = '0px';
    div.style.padding = "0px";
    div.style.lineHeight = "20px";
    div.classList.add("uniLegend");

    return div;
  }

  // NOx Point Sources
  var maxEmissions = 5658.8332;
  var minEmissions = 0.0000325;
  var rangeEmissions = maxEmissions - minEmissions;
  var numStepsEmissions = 100;

  function paintPointSources(feature, latlng) {
    var r = getCircleRadius(feature.properties.total_emissions);
      return L.circleMarker(latlng, {
        fillColor: '#000000',
        color: '#FFFFFF',
        weight: 1,
        opacity: 1,
        fillOpacity: 1,
        radius: r
    });
  }

  function onEachFeaturePointSources(feature, layer) {
      var address = "";
      if (feature.properties.address != "Unknown" && feature.properties.address != "UNKNOWN") {
        address = feature.properties.company_name + " " + feature.properties.address + " " + feature.properties.city + " " + feature.properties.postal_abbreviation;
        address = address.replace(" ", "+");
        address = "</br><a href='https://maps.google.com/?q=" + address + "'  target='_blank' rel='noopener noreferrer'>See it in Google Maps</a>";
      }
      /*var search = feature.properties.site_name + " " + feature.properties.company_name + " " + feature.properties.city + " " + feature.properties.state;
      search = search.replace(" ", "+");*/
      var book = feature.properties.company_name;
      if (book != "") log = "</br>Company name: " + book;
      else log = "";
      layer.bindPopup("Site name: " + titleCase(feature.properties.site_name.toLowerCase()) + log + "</br>Total Emissions: " + feature.properties.total_emissions + " tons\n" + address);
      //"<a href='http://www.google.com/search?q=" + search + "&btnI'>See the site</a>"
  }

  /*L.geoJson(houSources,
    {
      pointToLayer: paintPointSources,
      onEachFeature: onEachFeaturePointSources
    }).addTo(map);*/


  /* secondary functions */

  function titleCase(phrase) {
    var words = phrase.split(" ");
    var title = "";

    for (var i = 0; i < words.length; i++) {
      title += words[i][0].toUpperCase() + words[i].substr(1) + " ";
    }

    return title;
  }

  function getCircleRadius(x) {
    /*for (var i = numStepsEmissions; i >= 0; i--) {
      if (num >= scaleStep(i)) return circleAreaToRadius(scaleStep(num));
    }
    return circleAreaToRadius(scaleStep(numStepsEmissions));*/
    var a = getArea(x)*30;
    var r = circleAreaToRadius(a);
    return r;
  }

  function getArea(x) {
    var m = maxEmissions;
    var n = 10;
    return x >= m - (m/n)  ? 30 :
           x >= m - 2*(m/n)  ? 27 :
           x >= m - 3*(m/n)  ? 24 :
           x >= m - 4*(m/n)  ? 21 :
           x >= m - 5*(m/n)  ? 18 :
           x >= m - 6*(m/n)  ? 15 :
           x >= m - 7*(m/n)  ? 12 :
           x >= m - 8*(m/n)  ? 9 : //high
           x >= m - 9*(m/n)  ? 6 : //mid
                    3; //low
  }

  function scaleStep(stepNum) {
    //var range = Math.round(maxEmissions - minEmissions);
    var range = 50;

    //var range = 50;
    var segment = range/numStepsEmissions;
    return segment*stepNum;
  }

  function circleAreaToRadius(area) {
    var radius = area/Math.PI;
    radius = Math.sqrt(radius);
    return (Math.round(radius * 100)/100);
  }

  var log = "";
  var sourcesIsOn = false;
  var sources;
  function toggleLayer(layer) {
    if (!sourcesIsOn) {
      sources = L.geoJson(houSources,
        {
          pointToLayer: paintPointSources,
          onEachFeature: onEachFeaturePointSources
        });

      sources.addTo(map);
      //alert(log);
      sourcesIsOn = true;

      document.getElementById("sources").classList.toggle("activated");
    }
    else {
      map.removeLayer(sources);
      sourcesIsOn = false;

      document.getElementById("sources").classList.toggle("activated");
    }

  }

  map.setZoom(10);

</script>
